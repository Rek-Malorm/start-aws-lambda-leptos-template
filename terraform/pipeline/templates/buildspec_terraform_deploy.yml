version: 0.2

env:
  shell: bash
  variables:
    TF_BUCKET: "${remote_state_bucket}"
    TF_KEY: "${remote_state_key}"

phases:
  install:
    commands:
      - wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
      - echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
      - sudo apt update -y && sudo apt install terraform -y
  build:
    commands:
      - cd terraform/application/
      - |
        cat > terraform.tfvars.json <<EOF
        ${tfvars_content}
        EOF
      - terraform init -backend-config="bucket=$TF_BUCKET" -backend-config="key=$TF_KEY"
      - terraform apply -auto-approve
artifacts:
  files:
    - '**/*'